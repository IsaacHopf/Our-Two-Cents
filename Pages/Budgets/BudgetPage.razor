@inject BudgetsRepository BudgetsRepository
@inject FixedBudgetRepository FixedBudgetRepository
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

@page "/budgets/{budgetName}"

<MudStack StretchItems="StretchItems.End" Spacing="0" Class="h-100">
    
<MudStack Row="true" Class="mb-6">
    <MudStack Row="true" Spacing="0" AlignItems="AlignItems.Center">
        <MudTooltip Text="Back" Delay="650">
            <MudIconButton OnClick="@(() => NavigationManager.NavigateTo("/budgets"))" Icon="@Icons.Material.Rounded.ArrowBack" Size="Size.Medium" Class="me-4 pa-2"/>
        </MudTooltip>
        <MudText Typo="Typo.h4">@BudgetName</MudText>
    </MudStack>
    <MudStack Row="true" Spacing="5" Class="ms-auto me-2">
        <ReadOnlyCurrencyTextField Label="Total Income" Value="@_budget?.TotalIncome"/>
        <ReadOnlyCurrencyTextField Label="Total Expenses" Value="@(-_budget?.TotalExpenses)"/>
        <ReadOnlyCurrencyTextField Label="Net" Value="@_budget?.Net"/>
    </MudStack>
</MudStack>

@if (_budget is null)
{
    <MudStack AlignItems="AlignItems.Center">
        <MudProgressCircular Color="Color.Default" Indeterminate="true" Class="mt-6" />
    </MudStack>
}
else
{
    <MudTabs Rounded="true" ApplyEffectsToContainer="true" MinimumTabWidth="96px" Class="mud-tabs-scrollable-content">
        <MudTabPanel Text="Income" Icon="@Icons.Material.Rounded.AttachMoney">
            <TransactionsGrid IsIncome="true" Year="@_budget.Year" Month="@_budget.Month" Budget="@_budget"
                              Transactions="@_incomes" FixedTransactions="@_fixedBudget?.Incomes"
                              OnTransactionChanged="@UpdateIncomeAsync" OnDisableEdit="@ShowBudgetSavedPopup"/>
        </MudTabPanel>
        <MudTabPanel Text="Expenses" Icon="@Icons.Material.Rounded.MoneyOff">
            <TransactionsGrid IsIncome="false" Year="@_budget.Year" Month="@_budget.Month" Budget="@_budget"
                              Transactions="@_expenses" FixedTransactions="@_fixedBudget?.Expenses"
                              OnTransactionChanged="@UpdateExpensesAsync" OnDisableEdit="@ShowBudgetSavedPopup"/>
        </MudTabPanel>
        <MudTabPanel Text="Notes" Icon="@Icons.Material.Rounded.Notes">
            <MudPaper Class="w-100" Elevation="0">
                <MudTextField T="string?" Value="@_budget.Notes" ValueChanged="@UpdateNotesAsync" OnBlur="@ShowBudgetSavedPopup"
                              Variant="Variant.Outlined" Lines="10" AutoGrow="true"/>
            </MudPaper>
        </MudTabPanel>
    </MudTabs>
}
</MudStack>

@code {
    [Parameter] public required string BudgetName { get; set; }

    private Budget? _budget;
    private ObservableCollection<Transaction> _incomes = [];
    private ObservableCollection<Transaction> _expenses = [];
    private bool _hasBudgetChanged = false;

    private FixedBudget? _fixedBudget;
    
    protected override async Task OnInitializedAsync()
    {
        _budget = await BudgetsRepository.ReadAsync(BudgetName);
        _incomes = new ObservableCollection<Transaction>(_budget.Incomes);
        _expenses = new ObservableCollection<Transaction>(_budget.Expenses);

        _fixedBudget = await FixedBudgetRepository.ReadAsync();
        _fixedBudget.Incomes.ForEach(transaction =>
        {
            transaction.Date = transaction.Date.HasValue 
                ? new DateTime(_budget.Year, _budget.Month, transaction.Date.Value.Day) : null;
        });
        _fixedBudget.Expenses.ForEach(transaction =>
        {
            transaction.Date = transaction.Date.HasValue 
                ? new DateTime(_budget.Year, _budget.Month, transaction.Date.Value.Day) : null;
        });
    }

    private async Task UpdateIncomeAsync()
    {
        _budget!.Incomes = _incomes.ToList();
        _hasBudgetChanged = true;
        await BudgetsRepository.UpsertAsync(_budget!);
    }

    private async Task UpdateExpensesAsync()
    {
        _budget!.Expenses = _expenses.ToList();
        _hasBudgetChanged = true;
        await BudgetsRepository.UpsertAsync(_budget!);
    }

    private async Task UpdateNotesAsync(string? notes)
    {
        if (_budget!.Notes == notes) return;
        
        _budget!.Notes = notes;
        _hasBudgetChanged = true;
        await BudgetsRepository.UpsertAsync(_budget!);
    }

    private void ShowBudgetSavedPopup()
    {
        if (!_hasBudgetChanged) return;
        
        Snackbar.Add("Budget saved!", Severity.Success);
        _hasBudgetChanged = false;
    }
}